import { writeAtomicFileJSON } from "@aniojs/node-fs"
import {getEnkoreLockFilePath} from "./paths/getEnkoreLockFilePath.mts"
import {readEntityJSONFile} from "@enkore/spec"
import type {InstalledDependency} from "./installRealmDependencies/InstalledDependency.d.mts"

export async function updateLockFile(
	projectRoot: string,
	installedDependencies: InstalledDependency[],
	realmDependenciesStamp: string
) {
	const lockFilePath = getEnkoreLockFilePath(projectRoot)

	const currentLockFileData = await readEntityJSONFile(lockFilePath, "EnkoreLockFile", 0, 0, {
		autogeneratedFiles: {},
		realmDependencies: {},
		realmDependenciesStamp: ""
	})

	let realmDependencies : {
		[name: string]: {version: string}
	} = {}

	for (const dependency of installedDependencies) {
		realmDependencies[dependency.name] = {
			version: dependency.version
		}
	}

	await writeAtomicFileJSON(
		lockFilePath, {
			...currentLockFileData,
			realmDependencies,
			realmDependenciesStamp
		}, {pretty: true}
	)
}
